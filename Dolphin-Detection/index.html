!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edge Impulse Web Application</title>
</head>
<body>
  <div id="main">
    <audio id="audio" controls autoplay style="display:none;"></audio> <br>

    <table border=1 style="position:absolute; left:800px; top:0px; ">
      <tr><td>
        Version 0.9.19 <br>

        <div id="description">
          <div id="description-title" style="font-size:30px">Demo Edge Impulse WASM</div>
          Frequency ms <input type="text" id="myText01" value="130" onChange="{
             myFrequencyMs = this.value
             clearInterval(myTimer01)
             myTimer01 = setInterval(myAudioNow, myFrequencyMs);
          }"><br>

          <div id="myDiv01" style="font-size:30px">...</div>
          Stop Data Collection: <input type="checkbox" id="myCheckbox01"><br>
          Stop All Sounds <input type="checkbox" id="myCheckbox02sounds" ><br>

          <br>
          Default GRAYSCALE, Check to use Color <input type="checkbox" id="myCheckboxColor"><br><br>

          <textarea id="myTextArea01" style="display:none; " rows=10 cols=70>...</textarea> <br> <br> <br>

        </div>
      </td></tr>
    </table>

  </div>

  <script src="edge-impulse-standalone.js"></script>

  <audio preload="auto" id="backgroundNoise" src="background_noise.mp3"></audio>
  <audio preload="auto" id="Globicephala_macrorhynchus" src="globicephala_macrorhynchus.mp3"></audio>
  <audio preload="auto" id="Grampus_griseus" src="grampus_griseus.mp3"></audio>
  <audio preload="auto" id="Lagenodelphis_hosei" src="lagenodelphis_hosei.mp3"></audio>
  <audio preload="auto" id="Stenella_longirostis" src="stenella_longirostis.mp3"></audio>

  <script>
    let myTimer01 = 0;
    let myFrequencyMs = document.getElementById('myText01').value;
    let audioContext = new AudioContext();
    let sourceNode;
    let myOutputString = '';

    function myAudioNow() {
      let bufferLength = 4096;
      let dataArray = new Float32Array(bufferLength);

      sourceNode = audioContext.createMediaStreamSource(stream);
      let analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      sourceNode.connect(analyser);
      analyser.connect(audioContext.destination);

      analyser.getFloatTimeDomainData(dataArray);

      let data = Array.from(dataArray);

      let rms = Math.sqrt(data.reduce((acc, val) => acc + val * val, 0) / bufferLength);
      console.log('RMS:', rms);

      // Classify audio data and update UI
      classifyAudioData(data);
    }

    async function setupAudio() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioElement = document.getElementById('audio');
        audioElement.srcObject = stream;
        audioElement.play();

        return stream;
      } catch (err) {
        console.error('Error accessing microphone:', err);
      }
    }

    async function classifyAudioData(data) {
      const classifier = new EdgeImpulseClassifier();
      await classifier.init();

      const results = await classifier.classify(data);

      // Update UI with classification results
      updateClassificationResults(results);
    }

    function updateClassificationResults(results) {
      const labels = ['Background Noise', 'Globicephala macrorhynchus', 'Grampus griseus', 'Lagenodelphis hosei', 'Stenella longirostis'];

      let myTemp = '<table border=1  style="font-size:30px">';
      for (let i = 0; i < results.results.length; i++) {
        myTemp += `<tr><td>${labels[i]}</td><td>${results.results[i].value.toFixed(3)}</td></tr>`;
      }
      myTemp += '</table>';

      document.getElementById('myDiv01').innerHTML = 'results.anomaly: ' + results.anomaly + '<br>' + myTemp;
    }

    async function setupPage() {
      await setupAudio();

      // Start audio classification
      myTimer01 = setInterval(myAudioNow, myFrequencyMs);
    }

    // Initialize the page
    setupPage();
  </script>

  <script>
    // Classifier module
    let classifierInitialized = false;
    Module.onRuntimeInitialized = function () {
      classifierInitialized = true;
    };

    class EdgeImpulseClassifier {
      _initialized = false;

      getProperties() {
        return Module.get_properties();
      }

      init() {
        if (classifierInitialized === true) return Promise.resolve();

        return new Promise((resolve) => {
          Module.onRuntimeInitialized = () => {
            resolve();
            classifierInitialized = true;
          };
        });
      }

      async classify(data) {
        if (!classifierInitialized) throw new Error('Module is not initialized');

        const obj = this._arrayToHeap(data);
        let ret = Module.run_classifier(obj.buffer.byteOffset, data.length);
        Module._free(obj.ptr);

        if (ret.result !== 0) {
          throw new Error('Classification failed (err code: ' + ret.result + ')');
        }

        let jsResult = {
          anomaly: ret.anomaly,
          results: []
        };

        for (let cx = 0; cx < ret.classification.size(); cx++) {
          let c = ret.classification.get(cx);
          jsResult.results.push({ label: c.label, value: c.value });
          c.delete();
        }

        ret.delete();

        return jsResult;
      }

      _arrayToHeap(data) {
        let typedArray = new Float32Array(data);
        let numBytes = typedArray.length * typedArray.BYTES_PER_ELEMENT;
        let ptr = Module._malloc(numBytes);
        let heapBytes = new Uint8Array(Module.HEAPU8.buffer, ptr, numBytes);
        heapBytes.set(new Uint8Array(typedArray.buffer));
        return { ptr: ptr, buffer: heapBytes };
      }
    }
  </script>

  <script>
    // Provided code snippet integrated here
    for (let i = 0; i < results.results.length; i++) {
      if (myBestClassificationNumber == i) {   // check if this is the best one
        if (!document.getElementById('myCheckbox02sounds').checked) {

          if (!document.getElementById('myCheckbox03lable0').checked) {
            if (i == 0) { document.getElementById('mySound0').currentTime = 0; document.getElementById('mySound0').play() }
          }
          if (i == 1) { document.getElementById('mySound1').currentTime = 0; document.getElementById('mySound1').play() }
          if (i == 2) { document.getElementById('mySound2').currentTime = 0; document.getElementById('mySound2').play() }
          if (i == 3) { document.getElementById('mySound3').currentTime = 0; document.getElementById('mySound3').play() }
          if (i == 4) { document.getElementById('mySound4').currentTime = 0; document.getElementById('mySound4').play() }
          if (i == 5) { document.getElementById('mySound5').currentTime = 0; document.getElementById('mySound5').play() }
          if (i == 6) { document.getElementById('mySound6').currentTime = 0; document.getElementById('mySound6').play() }
          if (i == 7) { document.getElementById('mySound7').currentTime = 0; document.getElementById('mySound7').play() }
          if (i == 8) { document.getElementById('mySound8').currentTime = 0; document.getElementById('mySound8').play() }
        }

        myTemp += '<tr><td>' + results.results[i].label + '</td><td><font style=\'color:yellow; background-color:blue;\'>' + results.results[i].value.toFixed(3) + '</font></td></tr>'
      } else {
        myTemp += '<tr><td>' + results.results[i].label + '</td><td>' + results.results[i].value.toFixed(3) + '</td></tr>'
      }
    }

    myTemp += '</table>'
    //console.log(results) 

    document.getElementById('myDiv01').innerHTML = ' results.anomaly: ' + results.anomaly + '<br>' + myTemp
  </script>
</body>
</html>
