<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>SOSGuard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        #features {
            width: 50%;
            font-size: 18px;
        }

        #results {
            font-family: Arial, sans-serif;
            /* Changed font-family to Arial, you can replace it with your preferred font */
            white-space: pre;
        }

        /* Define the style for the flash effect */
        .flash {
            animation: flashAnimation 1s linear;
        }

        /* Define the keyframes for the flash animation */
        @keyframes flashAnimation {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row align-items-center border-bottom" id="header-row">
            <div class="col-auto mt-3 mb-3 pr-0">
            </div>
            <div class="col align-middle">
                <h1 class="text-dark mb-0 border-left pl-4"><i class="fas fa-shower mr-2"></i> SOSGuard</h1>
            </div>
        </div>

        <div class="row mt-4" id="permission-view">
            <div class="col">
                <div class="card shadow">
                    <div class="card-body text-center card-icon">
                        <i class="fas fa-mobile text-light">
                            <i class="fas fa-lock text-dark"></i>
                        </i>
                    </div>
                    <div class="card-body text-center pb-0">
                        <h2>Permission required</h2>
                    </div>
                    <div class="card-body text-center mb-4">
                        <button type="button" class="btn btn-primary" id="grant-permissions-button">Give access to the microphone</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4" id="inferencing-in-progress" style="display: none">
            <div class="col">
                <div class="card shadow">
                    <div class="card-body text-center mt-5">
                        <div class="col text-center mb--4">
                            <div class="sampling-circle"></div>
                            <div class="sampling-seconds-left text-gray" id="inferencing-time-left">&nbsp;</div>
                        </div>
                    </div>
                    <div class="card-body text-center pb-0 pt-0">
                        <h2 id="inferencing-recording-data-message">Listening...</h2>
                    </div>
                    <div class="card-body text-center text-lg" id="inferencing-result">

                    </div>
                </div>
            </div>
        </div>

        <!-- Element to display the classification flash -->
        <div id="classification"></div>
    </div>

    <script type="text/javascript" src="./adding/recorder.js"></script>
    <script type="text/javascript" src="./adding/microphone.js"></script>
    <script type="text/javascript" src="./Adding2/edge-impulse-standalone.js"></script>
    <script type="text/javascript" src="./Adding2/classifier.js"></script>
    <script>
        const sensor = new MicrophoneSensor();
        const grantPermissions = document.querySelector('#grant-permissions-button');
        const classifier = new edgeImpulseClassifier(); // Initialize the classifier object

        const views = {
        permission: document.querySelector('#permission-view'),
        inference: document.querySelector('#inferencing-in-progress'),
        inferenceResult: document.querySelector('#inferencing-result'),
        classificationElement: document.getElementById('classification')
       
        };

        const windowSize = 5 * 16000;
        const classifyWindowLength = 1 * 16000;
        const classifyWindowOverlap = 0.25 * 16000;

        async function classifyData() {
            const allData = []; // Assume you have data here
            const classifyCache = {}; // Your classification cache

            // if we have at least one window of data...
            if (allData.length >= windowSize) {
                let window = allData.slice(allData.length - windowSize, allData.length);

                // Iterate through each window
                for (let wx = 0; wx <= windowSize - classifyWindowLength; wx += classifyWindowOverlap) {
                    const cacheKey = allData.length - windowSize + wx;

                    let classifyResult;
                    if (!classifyCache[cacheKey]) {
                        let slice = window.slice(wx, wx + classifyWindowLength);

                        classifyCache[cacheKey] = classifier.classify(slice, false);
                    }

                    classifyResult = classifyCache[cacheKey];

                    // Process the classification result
                    let classifications = classifyResult.results.map(result => {
                        return {
                            label: result.label,
                            value: result.value
                        };
                    });

                    // Show the classification live
                    console.log('Classification at position', (allData.length / 16000) + 's:', classifications);
                    // Update UI with the classification if needed
                    updateUI(classifications);
                }
            }
        }

        function updateUI(classifications) {
            // Clear previous classification
            views.classificationElement.innerHTML = '';

            // Create a new element to display the classification
            let flashElement = document.createElement('div');
            flashElement.classList.add('flash');

            // Construct the text for the flash
            let flashText = classifications.map(classification => `${classification.label}: ${classification.value}`).join(', ');

            // Set the text content of the flash element
            flashElement.textContent = flashText;

            // Append the flash element to the classification element
            views.classificationElement.appendChild(flashElement);

            // After a short delay, remove the flash element
            setTimeout(() => {
                views.classificationElement.removeChild(flashElement);
            }, 1000); // Adjust the delay as needed (in milliseconds)
        }

        // Assuming you have code to handle permission request and microphone sampling
        // Add event listener to grant permissions button
        grantPermissions.addEventListener('click', async () => {
            // Request microphone permissions and start sampling
            const permissionGranted = await sensor.requestPermissions();
            if (permissionGranted) {
                // Display inference UI
                views.permission.style.display = 'none';
                views.inference.style.display = 'block';

                // Start sampling data
                await sensor.takeSample(200, 16000, () => {});

                // then take 1s of data
                sensor.takeSample(1000, 16000, classifyData);
            } else {
                alert('User has rejected microphone permissions');
            }
        });
    </script>
</body>

</html>
