<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Classification with Edge Impulse</title>
</head>
<body>
    <h1>Sound Classification with Edge Impulse</h1>
    <div id="classificationResult"></div>

    <script src="edge-impulse-standalone.js"></script>
    <script>
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let mediaRecorder;
        let audioChunks = [];

        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
                if (mediaRecorder.state === 'inactive') {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    classifyAudio(audioBlob);
                }
            };

            mediaRecorder.start();
        }

        async function classifyAudio(audioBlob) {
            const classifier = new EdgeImpulseClassifier();
            await classifier.init();

            const reader = new FileReader();
            reader.onload = async function () {
                const arrayBuffer = this.result;
                const rawAudio = new Float32Array(arrayBuffer);
                const classificationResult = await classifier.classify(rawAudio);
                displayClassificationResult(classificationResult);
            };
            reader.readAsArrayBuffer(audioBlob);
        }

        function displayClassificationResult(result) {
            const classificationDiv = document.getElementById('classificationResult');
            classificationDiv.innerHTML = '<h2>Classification Result</h2>';
            result.results.forEach(entry => {
                classificationDiv.innerHTML += `<p>${entry.label}: ${entry.value}</p>`;
            });
        }

        // Start recording on page load
        window.onload = function () {
            startRecording();
        };
    </script>
</body>
</html>
