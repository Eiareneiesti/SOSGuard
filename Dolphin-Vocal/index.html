<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Browser inference demo</title>

    <style>
        #results {
            font-family: monospace;
            white-space: pre;
        }
    </style>
</head>
<body>
    <h1></h1>

    <p>
        <button id="record-button">Start Recording</button>
    </p>
    <p id="results"></p>

    <script src="edge-impulse-standalone.js"></script>
    <script src="run-impulse.js"></script>
    <script>
        (async () => {
            var classifier = new EdgeImpulseClassifier();
            await classifier.init();

            let project = classifier.getProjectInfo();
            document.querySelector('h1').textContent = project.owner + ' / ' + project.name + ' (version ' + project.deploy_version + ')';

            const recordButton = document.getElementById('record-button');
            let isRecording = false;

            recordButton.addEventListener('click', async () => {
                if (!isRecording) {
                    isRecording = true;
                    recordButton.textContent = 'Stop Recording';
                    await startRecording();
                } else {
                    isRecording = false;
                    recordButton.textContent = 'Start Recording';
                    await stopRecording();
                }
            });

            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const mediaRecorder = new MediaRecorder(stream);
                    const audioChunks = [];

                    mediaRecorder.addEventListener('dataavailable', event => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener('stop', async () => {
                        const audioBlob = new Blob(audioChunks);
                        const audioUrl = URL.createObjectURL(audioBlob);

                        const audio = new Audio(audioUrl);
                        audio.controls = true;
                        document.body.appendChild(audio);

                        const classificationResult = await classifyAudio(audioBlob);
                        document.querySelector('#results').textContent = JSON.stringify(classificationResult, null, 4);
                    });

                    mediaRecorder.start();
                    setTimeout(() => {
                        mediaRecorder.stop();
                    }, 2000); // Record for 2 seconds
                } catch (error) {
                    console.error('Error starting recording:', error);
                }
            }

            async function stopRecording() {
                // This function will be handled in startRecording() when the mediaRecorder stops automatically after 2 seconds.
            }

            async function classifyAudio(audioBlob) {
                try {
                    return await classifier.classifyBlob(audioBlob);
                } catch (error) {
                    console.error('Error classifying audio:', error);
                    return { error: 'Error classifying audio' };
                }
            }
        })();
    </script>
</body>
</html>
