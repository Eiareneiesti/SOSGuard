<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Audio Classification Demo</title>
</head>
<body>
    <h1>Audio Classification Demo</h1>

    <p>
        <button id="start-recording">Start Recording</button>
        <button id="stop-recording" disabled>Stop Recording</button>
    </p>

    <p id="results"></p>

    <script>
        (function() {
            let classifierInitialized = false;

            // Callback when the classifier is initialized
            Module.onRuntimeInitialized = function() {
                classifierInitialized = true;
            };

            let ptrs = {};
            Module.onMalloc = function onMalloc(ptr, size) {
                ptrs[ptr] = size;
            };
            Module.onFree = function onFree(ptr) {
                delete ptrs[ptr];
            };

            class EdgeImpulseClassifier {
                constructor() {
                    this._initialized = false;
                }

                // Initialize the classifier
                init() {
                    if (classifierInitialized === true) return Promise.resolve();

                    return new Promise((resolve) => {
                        Module.onRuntimeInitialized = () => {
                            resolve();
                            classifierInitialized = true;
                        };
                    });
                }

                // Perform classification on audio data
                classify(rawData, debug = false) {
                    if (!classifierInitialized) throw new Error('Module is not initialized');

                    const obj = this._arrayToHeap(rawData);
                    let ret = Module.run_classifier(obj.bytes.byteOffset, rawData.length, debug);
                    Module._free(obj.ptr);

                    if (ret.result !== 0) {
                        throw new Error('Classification failed (err code: ' + ret.result + ')');
                    }

                    let jsResult = {
                        anomaly: ret.anomaly,
                        results: []
                    };

                    for (let cx = 0; cx < ret.classification.size(); cx++) {
                        let c = ret.classification.get(cx);
                        jsResult.results.push({ label: c.label, value: c.value });
                    }

                    return jsResult;
                }

                // Convert JavaScript array to memory heap for C++ consumption
                _arrayToHeap(data) {
                    let typedArray = new Float32Array(data);
                    let numBytes = typedArray.length * typedArray.BYTES_PER_ELEMENT;
                    let ptr = Module._malloc(numBytes);
                    let heapBytes = new Uint8Array(Module.HEAPU8.buffer, ptr, numBytes);
                    heapBytes.set(new Uint8Array(typedArray.buffer));
                    return { ptr: ptr, bytes: heapBytes };
                }
            }

            // Expose EdgeImpulseClassifier to the global scope
            window.EdgeImpulseClassifier = EdgeImpulseClassifier;

            // Your code for recording audio and classifying it goes here
            let mediaRecorder;
            let chunks = [];

            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = (e) => {
                        chunks.push(e.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const blob = new Blob(chunks, { 'type': 'audio/ogg; codecs=opus' });
                        chunks = [];

                        // Use Edge Impulse for classification
                        try {
                            const classifier = new EdgeImpulseClassifier();
                            await classifier.init();

                            const result = await classifier.classify(blob);
                            document.getElementById('results').textContent = JSON.stringify(result, null, 4);
                        } catch (error) {
                            console.error('Classification error: ', error);
                        }
                    };

                    mediaRecorder.start();
                    document.getElementById('start-recording').disabled = true;
                    document.getElementById('stop-recording').disabled = false;
                } catch (err) {
                    console.error('Error: ' + err);
                }
            };

            const stopRecording = () => {
                mediaRecorder.stop();
                document.getElementById('start-recording').disabled = false;
                document.getElementById('stop-recording').disabled = true;
            };

            document.getElementById('start-recording').addEventListener('click', startRecording);
            document.getElementById('stop-recording').addEventListener('click', stopRecording);
        })();
    </script>
</body>
</html>
