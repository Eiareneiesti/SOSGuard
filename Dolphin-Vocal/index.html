<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Edge Impulse Audio Classification Demo</title>
</head>
<body>
    <h1>Edge Impulse Audio Classification Demo</h1>

    <p>
        <button id="record-button">Start Recording</button>
    </p>

    <div id="results"></div>

    <script src="https://cdn.edgeimpulse.com/edge-impulse-sdk-latest.js"></script>
    <script>
        (async () => {
            const classifier = new EdgeImpulseClassifier();
            await classifier.init();

            const recordButton = document.getElementById('record-button');
            let isRecording = false;

            recordButton.addEventListener('click', async () => {
                if (!isRecording) {
                    isRecording = true;
                    recordButton.textContent = 'Stop Recording';
                    await startRecording();
                } else {
                    isRecording = false;
                    recordButton.textContent = 'Start Recording';
                    await stopRecording();
                }
            });

            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const mediaRecorder = new MediaRecorder(stream);
                    const audioChunks = [];

                    mediaRecorder.addEventListener('dataavailable', event => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener('stop', async () => {
                        const audioBlob = new Blob(audioChunks);
                        const classificationResult = await classifyAudio(audioBlob);

                        document.getElementById('results').textContent = JSON.stringify(classificationResult, null, 2);
                    });

                    mediaRecorder.start();
                    setTimeout(() => {
                        mediaRecorder.stop();
                    }, 3000); // Record for 3 seconds
                } catch (error) {
                    console.error('Error starting recording:', error);
                }
            }

            async function stopRecording() {
                // This function will be handled in startRecording() when the mediaRecorder stops automatically after 3 seconds.
            }

            async function classifyAudio(audioBlob) {
                try {
                    return await classifier.classifyBlob(audioBlob);
                } catch (error) {
                    console.error('Error classifying audio:', error);
                    return { error: error.message }; // Return the error message for debugging
                }
            }
        })();
    </script>
</body>
</html>
