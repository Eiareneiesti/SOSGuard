<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Browser inference demo</title>

    <style>
        #results {
            font-family: monospace;
            white-space: pre;
        }
    </style>
</head>
<body>
    <h1></h1>

    <p>
        <button id="start-recording">Start Recording</button>
        <button id="stop-recording" disabled>Stop Recording</button>
    </p>

    <p id="results"></p>

    <script src="edge-impulse-standalone.js"></script>
    <script src="run-impulse.js"></script>
    <script>
        (async () => {
            var classifier = new EdgeImpulseClassifier();
            await classifier.init();

            let project = classifier.getProjectInfo();
            document.querySelector('h1').textContent = project.owner + ' / ' + project.name + ' (version ' + project.deploy_version + ')';

            let mediaRecorder;
            let chunks = [];

            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = (e) => {
                        chunks.push(e.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const blob = new Blob(chunks, { 'type': 'audio/ogg; codecs=opus' });
                        chunks = [];
                        const audioURL = window.URL.createObjectURL(blob);

                        const audio = new Audio(audioURL);
                        audio.controls = true;
                        document.body.appendChild(audio);

                        // Use Edge Impulse for classification
                        classifier.classifyAudioBlob(blob)
                            .then(result => {
                                document.querySelector('#results').textContent = JSON.stringify(result, null, 4);
                            })
                            .catch(error => {
                                console.error('Classification error: ', error);
                            });
                    };

                    mediaRecorder.start();
                    document.getElementById('start-recording').disabled = true;
                    document.getElementById('stop-recording').disabled = false;
                } catch (err) {
                    console.error('Error: ' + err);
                }
            };

            const stopRecording = () => {
                mediaRecorder.stop();
                document.getElementById('start-recording').disabled = false;
                document.getElementById('stop-recording').disabled = true;
            };

            document.getElementById('start-recording').addEventListener('click', startRecording);
            document.getElementById('stop-recording').addEventListener('click', stopRecording);
        })();
    </script>
</body>
</html>

