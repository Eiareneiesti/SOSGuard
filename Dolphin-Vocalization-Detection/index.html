<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SOSGuard</title>

    <style>
        #features {
            width: 50%;
            font-size: 18px;
        }

        #results {
            font-family: monospace;
            white-space: pre;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row align-items-center border-bottom" id="header-row">
            <div class="col-auto mt-3 mb-3 pr-0">
                <!-- <img src="./assets/mark.svg"> Insert imong logo -->
            </div>
            <div class="col align-middle">
                <h1 class="text-dark mb-0 border-left pl-4"><i class="fas fa-shower mr-2"></i> SOSGuard</h1>
            </div>
        </div>

        <div class="row mt-4" id="permission-view">
            <div class="col">
                <div class="card shadow">
                    <div class="card-body text-center card-icon">
                        <i class="fas fa-mobile text-light">
                            <i class="fas fa-lock text-dark"></i>
                        </i>
                    </div>
                    <div class="card-body text-center pb-0">
                        <h2>Permission required</h2>
                    </div>
                    <div class="card-body text-center mb-4">
                        <button type="button" class="btn btn-primary" id="grant-permissions-button">Give access to the microphone</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4" id="inferencing-in-progress" style="display: none">
            <div class="col">
                <div class="card shadow">
                    <div class="card-body text-center mt-5">
                        <div class="col text-center mb--4">
                            <div class="sampling-circle"></div>
                            <div class="sampling-seconds-left text-gray" id="inferencing-time-left">&nbsp;</div>
                        </div>
                    </div>
                    <div class="card-body text-center pb-0 pt-0">
                        <h2 id="inferencing-recording-data-message">Listening...</h2>
                    </div>
                    <div class="card-body text-center text-lg" id="inferencing-result">

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="./recorder.js"></script>
    <script type="text/javascript" src="./microphone.js"></script>
    <script type="text/javascript" src="./edge-impulse-standalone.js"></script>
    <script type="text/javascript" src="./classifier.js"></script>
    <script>
        const sensor = new MicrophoneSensor();
        const grantPermissions = document.querySelector('#grant-permissions-button');

        const views = {
            permission: document.querySelector('#permission-view'),
            inference: document.querySelector('#inferencing-in-progress'),
            inferenceResult: document.querySelector('#inferencing-result')
        };

        // store results here so we don't invoke the classifier again for the same window
        const classifyCache = {};

        grantPermissions.onclick = ev => {
            ev.preventDefault();

            if (!sensor.hasSensor()) {
                return alert('Your device does not seem to have a microphone');
            }
            
         sensor.checkPermissions(true).then(async (result) => {
            if (result) {
                const classifier = window.classifier = new EdgeImpulseClassifier();
                await classifier.init();

                 views.permission.style.display = 'none';
                 views.inference.style.display = '';

                 let allData = [];
                 let allClassifications = [];
                 let showerStarted = null;

                 const onSampleComplete = (obj) => {
                     sensor.takeSample(1000, 16000, () => {}).then(onSampleComplete);

                     allData = allData.concat(obj.values);
                     console.log(Date.now(), 'allData is', allData.length / 16000, 'seconds');

                     const windowSize = 5 * 16000;
                     const windowStep = 1 * 16000;
                     const classifyWindowLength = 1 * 16000;
                     const classifyWindowOverlap = 0.25 * 16000;

                        // if we have at least one window of data...
                     if (allData.length >= windowSize) {
                        let window = allData.slice(allData.length - windowSize, allData.length);

                        let GlobicephalaMacrorhynchusCount = 0;
                        let GrampusGriseusCount = 0;
                        let LagenodelphisHoseiCount = 0;
                        let StenellaLongirostisCount = 0;
                        
                        // in here we'll take 1 second slices, with 300 ms. overlap that we then classify (total 14 windows)
                        console.time('classifyWindow');
                        for (let wx = 0; wx <= windowSize - classifyWindowLength; wx += classifyWindowOverlap) {
                            const cacheKey = allData.length - windowSize + wx;
                        
                            let classifyResult;
                            if (!classifyCache[cacheKey]) {
                                let slice = window.slice(wx, wx + classifyWindowLength);
                        
                                classifyCache[cacheKey] = classifier.classify(slice, false);
                            }
                        
                            classifyResult = classifyCache[cacheKey];
                            let GlobicephalaMacrorhynchus = classifyResult.results.find(r => r.label === 'Globicephala macrorhynchus').value;
                            let GrampusGriseus = classifyResult.results.find(r => r.label === 'Grampus griseus').value;
                            let LagenodelphisHosei = classifyResult.results.find(r => r.label === 'Lagenodelphis hosei').value;
                            let StenellaLongirostis = classifyResult.results.find(r => r.label === 'Stenella longirostis').value;
                        
                            if (GlobicephalaMacrorhynchus >= 0.6) {
                                GlobicephalaMacrorhynchusCount++;
                            } else if (GrampusGriseus >= 0.6) {
                                GrampusGriseusCount++;
                            } else if (LagenodelphisHosei >= 0.6) {
                                LagenodelphisHoseiCount++;
                            } else if (StenellaLongirostis >= 0.6) {
                                StenellaLongirostisCount++;
                            }
                        }
                        console.timeEnd('classifyWindow');
                        
                        let totalCount = GlobicephalaMacrorhynchusCount + GrampusGriseusCount + LagenodelphisHoseiCount + StenellaLongirostisCount;
                        let conclusion = 'uncertain';
                        if (GlobicephalaMacrorhynchusCount / totalCount >= 0.6) {
                            allClassifications.push('Globicephala macrorhynchus');
                            conclusion = 'Globicephala macrorhynchus';
                        } else if (GrampusGriseusCount / totalCount >= 0.8) {
                            allClassifications.push('Grampus griseus');
                            conclusion = 'Grampus griseus';
                        } else if (LagenodelphisHoseiCount / totalCount >= 0.6) {
                            allClassifications.push('Lagenodelphis hosei');
                            conclusion = 'Lagenodelphis hosei';
                        } else if (StenellaLongirostisCount / totalCount >= 0.6) {
                            allClassifications.push('Stenella longirostis');
                            conclusion = 'Stenella longirostis';
                        } else {
                            allClassifications.push('uncertain');
                            // totalUncertain++;
                        }
                        
                     }  
             };
                    // start up the sensor
                    await sensor.takeSample(200, 16000, () => {});

                    // then take 1s of data
                    sensor.takeSample(1000, 16000, () => {}).then(onSampleComplete);
                }
                else {
                    alert('User has rejected microphone permissions');
                }
            });
         }
        </script>
    </body>
    </html>
                            
